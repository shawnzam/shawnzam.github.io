---
import { getCollection } from 'astro:content';
import SiteLayout from '../../layouts/SiteLayout.astro';

const allPosts = await getCollection('blog');
const posts = allPosts.sort((a, b) => b.data.published.getTime() - a.data.published.getTime());

// Extract excerpt from raw markdown body (first non-heading paragraph)
function getExcerpt(body: string, maxLength = 200): string {
  const lines = body.split('\n');
  for (const line of lines) {
    const trimmed = line.trim();
    if (trimmed && !trimmed.startsWith('#') && !trimmed.startsWith('---') && !trimmed.startsWith('!')) {
      return trimmed.length > maxLength ? trimmed.slice(0, maxLength) + '...' : trimmed;
    }
  }
  return '';
}

const ogImage = posts.length > 0
  ? `https://zamechek.com/blog/${posts[0].slug}.png`
  : 'https://zamechek.com/me.jpg';

const ldJson = {
  "@context": "https://schema.org",
  "@type": "Blog",
  "name": "Shawn Zamechek Blog",
  "url": "https://zamechek.com/blog/",
  "description": "Writing on AI, research, and learning.",
  "publisher": {
    "@type": "Person",
    "name": "Shawn Zamechek"
  },
  "blogPost": posts.map(p => ({
    "@type": "BlogPosting",
    "headline": p.data.title,
    "datePublished": p.data.published.toISOString().split('T')[0],
    "url": `https://zamechek.com/blog/${p.slug}/`,
    "author": { "@type": "Person", "name": "Shawn Zamechek" }
  }))
};
---

<SiteLayout
  title="Shawn Zamechek | Blog"
  description="Writing on AI, research, and learning."
  canonical="https://zamechek.com/blog/"
  ogImage={ogImage}
  ldJson={ldJson}
>
  <main class="flex-1 container mx-auto px-4 py-12">
    <div class="max-w-3xl mx-auto">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Posts</h2>
        <a href="/blog/rss.xml" class="text-orange-700 hover:underline font-semibold text-sm">RSS</a>
      </div>

      <div class="space-y-8">
        {posts.map(post => {
          const slug = post.slug;
          const imgSrc = `/blog/${slug}.png`;
          const excerpt = getExcerpt(post.body);
          const formattedDate = post.data.published.toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric'
          });

          return (
            <article class="bg-white p-6 rounded shadow border border-gray-200">
              <a href={`/blog/${slug}/`} class="block mb-4">
                <img
                  src={imgSrc}
                  alt={`Title image for ${post.data.title}`}
                  class="w-full h-56 sm:h-64 object-cover rounded-lg border border-gray-200"
                  loading="lazy"
                />
              </a>
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-3">
                <h3 class="text-xl font-semibold text-gray-900">{post.data.title}</h3>
                <span class="text-xs font-semibold tracking-wide text-gray-500 uppercase">{post.data.type}</span>
              </div>
              <p class="text-sm text-gray-500 mb-3">Published: {formattedDate}</p>
              {excerpt && <p class="text-gray-700 mb-4">{excerpt}</p>}
              <a href={`/blog/${slug}/`} class="text-blue-700 hover:underline font-semibold">Read post</a>
            </article>
          );
        })}
      </div>
    </div>
  </main>
</SiteLayout>
